(function(x,f,r,_,yt,M,Q,E,S,Z,xe,ee){"use strict";const l={DEFAULT_APP_NAME:"Music",DEFAULT_TIME_INTERVAL:5,APPLICATION_ID:"1054951789318909972",MIN_UPDATE_INTERVAL:3,MAX_RETRY_ATTEMPTS:3,RETRY_DELAY:5e3,SERVICES:{lastfm:{name:"Last.fm",baseUrl:"http://ws.audioscrobbler.com/2.0",requiresApiKey:!0,requiresToken:!1},librefm:{name:"Libre.fm",baseUrl:"http://libre.fm/api",requiresApiKey:!0,requiresToken:!1},listenbrainz:{name:"ListenBrainz",baseUrl:"http://api.listenbrainz.org/1",requiresApiKey:!1,requiresToken:!0}},DEFAULT_COVER_HASHES:["2a96cbd8b46e442fc41c2b86b821562f","c6f59c1e5e7240a4c0d427abd71f3dbb"],DEFAULT_SETTINGS:{username:"",apiKey:"",appName:"Music",timeInterval:5,showTimestamp:!0,listeningTo:!0,ignoreSpotify:!0,ignoreYouTubeMusic:!0,ignoreKizzy:!0,ignoreMetrolist:!0,verboseLogging:!1,service:void 0,librefmUsername:"",librefmApiKey:"",listenbrainzUsername:"",listenbrainzToken:""},API_ERROR_CODES:{2:"Invalid service",3:"Invalid method",4:"Invalid format",5:"Invalid parameters",6:"Invalid resource specified",7:"Invalid session key",8:"Invalid API key",9:"Invalid session",10:"Invalid API signature",11:"Service offline",13:"Invalid method signature supplied",16:"Service temporarily unavailable",26:"Suspended API key",29:"Rate limit exceeded"}};function V(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function fe(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function F(e,t,n){return t&&fe(e.prototype,t),n&&fe(e,n),e}const{SET_ACTIVITY:ht}=_.findByProps("SET_ACTIVITY"),Ge=_.findByProps("getAssetIds"),q=_.findByStoreName("SelfPresenceStore"),de=_.findByStoreName("UserStore"),pe=function(...e){return console.log("[Activity]",...e)},Ye=function(...e){return console.error("[Activity] Error:",...e)},G=function(...e){try{console.log("[Activity] Verbose:",...e)}catch{console.log("[Activity] Verbose:",...e)}};function O(){return pe("Clearing Discord activity"),be(null)}function be(e){h.pluginStopped&&(G("Plugin is stopped, clearing activity"),se(),e=null),h.lastActivity=e,G("Dispatching activity update:",e?"Setting activity":"Clearing activity"),r.FluxDispatcher.dispatch({type:"LOCAL_ACTIVITY_UPDATE",activity:e,pid:2312,socketId:"Multi-Service-Scrobbler@Vendetta"}),pe(e?`Activity set: ${e.details} - ${e.state}`:"Activity cleared")}async function qe(e,t=l.APPLICATION_ID){if(!e?.length)return G("No assets to fetch"),[];try{G(`Fetching ${e.length} asset(s):`,e);const n=await Ge.fetchAssetIds(t,e);return G(`Successfully fetched ${n.length} asset(s)`),n}catch(n){return Ye("Failed to fetch assets:",n),[]}}const b={};b.componentMountErrors=[],b.componentMountCount=0,b.settingsLoadAttempts=0,b.serviceErrors={lastfm:[],librefm:[],listenbrainz:[]},b.apiCallCount=0,b.connectionAttempts=0,b.lastCredentialValidation={lastfm:!1,librefm:!1,listenbrainz:!1};const j=function(...e){return console.log("[Debug]",...e)},ye=function(...e){return console.error("[Debug] Error:",...e)};function P(e,t){b[e]=t,e==="lastError"&&t?ye("Error recorded:",t.message):e==="lastTrack"&&t?j("Track updated:",`${t.artist} - ${t.name}`):e==="currentService"&&t&&j("Service changed to:",t)}function he(){b.apiCallCount=(b.apiCallCount||0)+1,j(`API call count: ${b.apiCallCount}`)}function X(e,t){b.serviceErrors=b.serviceErrors||{lastfm:[],librefm:[],listenbrainz:[]},b.serviceErrors[e]=b.serviceErrors[e]||[],b.serviceErrors[e].push(`${new Date().toISOString()}: ${t}`),b.serviceErrors[e].length>10&&(b.serviceErrors[e]=b.serviceErrors[e].slice(-10)),ye(`${e} error:`,t)}function ve(){b.lastSuccessfulUpdate=new Date().toISOString(),j("Successful update recorded at:",b.lastSuccessfulUpdate)}function H(e){return H=Object.setPrototypeOf?Object.getPrototypeOf:function(n){return n.__proto__||Object.getPrototypeOf(n)},H(e)}function me(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}))}catch{}return(me=function(){return!!e})()}function je(e){if(e===void 0)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function Xe(e){"@swc/helpers - typeof";return e&&typeof Symbol<"u"&&e.constructor===Symbol?"symbol":typeof e}function He(e,t){return t&&(Xe(t)==="object"||typeof t=="function")?t:je(e)}function te(e,t,n){return t=H(t),He(e,me()?Reflect.construct(t,n||[],H(e).constructor):t.apply(e,n))}function ne(e,t){return ne=Object.setPrototypeOf||function(i,a){return i.__proto__=a,i},ne(e,t)}function re(e,t){if(typeof t!="function"&&t!==null)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&ne(e,t)}let ie=(function(){function e(){V(this,e)}return F(e,[{key:"log",value:function(...t){console.log(`[${this.getServiceName()}]`,...t)}},{key:"logError",value:function(...t){console.error(`[${this.getServiceName()}] Error:`,...t)}},{key:"logVerbose",value:function(...t){console.log(`[${this.getServiceName()}] Verbose:`,...t)}},{key:"handleError",value:async function(t){this.lastError=t.error||0;const n=this.getErrorMessage(t);throw this.logError(n),X(this.getServiceName().toLowerCase(),n),new Error(`${this.getServiceName()} API Error: ${n}`)}},{key:"getErrorMessage",value:function(t){return t.error&&l.API_ERROR_CODES[t.error]?l.API_ERROR_CODES[t.error]:t.message||t.toString()||"Unknown error"}},{key:"makeRequest",value:async function(t,n={}){try{this.logVerbose(`Making request to: ${t}`),he();const i=await fetch(t,{...n,headers:{"User-Agent":"Vendetta Multi-Service Scrobbler/3.0.0",...n.headers}});if(!i.ok){const s=new Error(`HTTP ${i.status}: ${i.statusText}`);throw X(this.getServiceName().toLowerCase(),s.message),s}const a=await i.json();return a.error&&await this.handleError(a),this.retryCount=0,a}catch(i){if(this.retryCount++,this.retryCount>l.MAX_RETRY_ATTEMPTS)throw this.retryCount=0,X(this.getServiceName().toLowerCase(),`Max retries exceeded: ${i.message}`),i;return this.logVerbose(`Request failed, retrying (${this.retryCount}/${l.MAX_RETRY_ATTEMPTS})`),await new Promise(function(a){return setTimeout(a,l.RETRY_DELAY)}),this.makeRequest(t,n)}}},{key:"isDefaultCover",value:function(t){return t?l.DEFAULT_COVER_HASHES.some(function(n){return t.includes(n)}):!0}},{key:"processAlbumArt",value:function(t){return!t||this.isDefaultCover(t)?null:t}},{key:"getLastError",value:function(){return this.lastError}},{key:"resetRetryCount",value:function(){this.retryCount=0}}]),e})(),We=(function(e){re(t,e);function t(){return V(this,t),te(this,t,arguments)}return F(t,[{key:"getServiceName",value:function(){return"Last.fm"}},{key:"logVerbose",value:function(...n){o.verboseLogging&&console.log(`[${this.getServiceName()}] Verbose:`,...n)}},{key:"validateCredentials",value:async function(){try{if(!o.username||!o.apiKey)throw new Error("Username or API key not set");const n=new URLSearchParams({method:"user.getinfo",user:o.username,api_key:o.apiKey,format:"json"}),i=`${l.SERVICES.lastfm.baseUrl}?${n}`;return await this.makeRequest(i),this.log("Credentials validation successful"),!0}catch(n){return this.logError("Credentials validation failed:",n),!1}}},{key:"fetchLatestScrobble",value:async function(){try{if(!o.username||!o.apiKey)throw new Error("Username or API key not set");this.logVerbose("Fetching latest scrobble for user:",o.username);const n=new URLSearchParams({method:"user.getrecenttracks",user:o.username,api_key:o.apiKey,limit:"1",extended:"1",format:"json"}),i=`${l.SERVICES.lastfm.baseUrl}?${n}`,a=(await this.makeRequest(i))?.recenttracks?.track?.[0];if(!a)throw new Error("No tracks found");this.logVerbose("Raw track data:",a);const s=!!a["@attr"]?.nowplaying,c=a.date?.uts?parseInt(a.date.uts):Math.floor(Date.now()/1e3);let g=null,d=null;if(s)try{const L=new URLSearchParams({method:"track.getInfo",track:a.name,artist:a.artist.name,api_key:o.apiKey,format:"json"}),C=`${l.SERVICES.lastfm.baseUrl}?${L}`,R=await this.makeRequest(C);R?.track?.duration&&(g=parseInt(R.track.duration),g>0&&(g=Math.floor(g/1e3),d=c+g))}catch(L){this.logVerbose("Failed to fetch track duration:",L)}const v=this.processAlbumArt(a.image?.find(function(L){return L.size==="large"})?.["#text"]),k={name:a.name,artist:a.artist.name,album:a.album["#text"],albumArt:v,url:a.url,date:a.date?.["#text"]??"now",nowPlaying:s,loved:a.loved==="1",from:c,to:d,duration:g};return this.logVerbose("Processed track:",k),this.log(`${s?"Now playing":"Last played"}:`,`${k.artist} - ${k.name}`),k}catch(n){throw this.logError("Failed to fetch latest scrobble:",n),n}}}]),t})(ie),Je=(function(e){re(t,e);function t(){return V(this,t),te(this,t,arguments)}return F(t,[{key:"getServiceName",value:function(){return"Libre.fm"}},{key:"logVerbose",value:function(...n){o.verboseLogging&&console.log(`[${this.getServiceName()}] Verbose:`,...n)}},{key:"validateCredentials",value:async function(){try{const n=o.librefmUsername,i=o.librefmApiKey;if(!n||!i)throw new Error("Username or API key not set for Libre.fm");const a=new URLSearchParams({method:"user.getinfo",user:n,api_key:i,format:"json"}),s=`${l.SERVICES.librefm.baseUrl}?${a}`;return await this.makeRequest(s),this.log("Credentials validation successful"),!0}catch(n){return this.logError("Credentials validation failed:",n),!1}}},{key:"fetchLatestScrobble",value:async function(){try{const n=o.librefmUsername,i=o.librefmApiKey;if(!n||!i)throw new Error("Username or API key not set for Libre.fm");this.logVerbose("Fetching latest scrobble for user:",n);const a=new URLSearchParams({method:"user.getrecenttracks",user:n,api_key:i,limit:"1",extended:"1",format:"json"}),s=`${l.SERVICES.librefm.baseUrl}?${a}`,c=(await this.makeRequest(s))?.recenttracks?.track?.[0];if(!c)throw new Error("No tracks found");this.logVerbose("Raw track data:",c);const g=!!c["@attr"]?.nowplaying,d=c.date?.uts?parseInt(c.date.uts):Math.floor(Date.now()/1e3);let v=null,k=null;if(g)try{const R=new URLSearchParams({method:"track.getInfo",track:c.name,artist:c.artist.name,api_key:i,format:"json"}),U=`${l.SERVICES.librefm.baseUrl}?${R}`,Ke=await this.makeRequest(U);Ke?.track?.duration&&(v=parseInt(Ke.track.duration),v>0&&(v=Math.floor(v/1e3),k=d+v))}catch(R){this.logVerbose("Failed to fetch track duration:",R)}const L=this.processAlbumArt(c.image?.find(function(R){return R.size==="large"})?.["#text"]),C={name:c.name,artist:c.artist.name,album:c.album["#text"],albumArt:L,url:c.url,date:c.date?.["#text"]??"now",nowPlaying:g,loved:c.loved==="1",from:d,to:k,duration:v};return this.logVerbose("Processed track:",C),this.log(`${g?"Now playing":"Last played"}:`,`${C.artist} - ${C.name}`),C}catch(n){throw this.logError("Failed to fetch latest scrobble:",n),n}}}]),t})(ie),Qe=(function(e){re(t,e);function t(){return V(this,t),te(this,t,arguments)}return F(t,[{key:"getServiceName",value:function(){return"ListenBrainz"}},{key:"logVerbose",value:function(...n){o.verboseLogging&&console.log(`[${this.getServiceName()}] Verbose:`,...n)}},{key:"validateCredentials",value:async function(){try{const n=o.listenbrainzUsername,i=o.listenbrainzToken;if(!n)throw new Error("Username not set for ListenBrainz");const a=`${l.SERVICES.listenbrainz.baseUrl}/user/${encodeURIComponent(n)}/listens?count=1`,s={};return i&&(s.Authorization=`Token ${i}`),await this.makeRequest(a,{headers:s}),this.log("Credentials validation successful"),!0}catch(n){return this.logError("Credentials validation failed:",n),!1}}},{key:"fetchLatestScrobble",value:async function(){try{const n=o.listenbrainzUsername,i=o.listenbrainzToken;if(!n)throw new Error("Username not set for ListenBrainz");this.logVerbose("Fetching latest scrobble for user:",n);let a=null;try{const C=`${l.SERVICES.listenbrainz.baseUrl}/user/${encodeURIComponent(n)}/playing-now`,R={};i&&(R.Authorization=`Token ${i}`);const U=await this.makeRequest(C,{headers:R});U.listens&&U.listens.length>0&&(a=U.listens[0],a.playing_now=!0)}catch(C){this.logVerbose("No currently playing track or failed to fetch:",C)}let s;if(a)s=a,this.logVerbose("Using currently playing track");else{const C=`${l.SERVICES.listenbrainz.baseUrl}/user/${encodeURIComponent(n)}/listens?count=1`,R={};i&&(R.Authorization=`Token ${i}`);const U=await this.makeRequest(C,{headers:R});if(!U.listens||U.listens.length===0)throw new Error("No listens found");s=U.listens[0],this.logVerbose("Using latest completed listen")}this.logVerbose("Raw listen data:",s);const c=!!s.playing_now,g=s.listened_at||Math.floor(Date.now()/1e3);let d=null,v=null;s.track_metadata.additional_info?.duration_ms&&(d=Math.floor(s.track_metadata.additional_info.duration_ms/1e3),c&&d>0&&(v=g+d));const k=null;s.track_metadata.additional_info?.release_mbid;const L={name:s.track_metadata.track_name,artist:s.track_metadata.artist_name,album:s.track_metadata.release_name||"",albumArt:k,url:s.track_metadata.additional_info?.origin_url||`https://listenbrainz.org/user/${n}`,date:c?"now":new Date(g*1e3).toISOString(),nowPlaying:c,loved:!1,from:g,to:v,duration:d};return this.logVerbose("Processed track:",L),this.log(`${c?"Now playing":"Last played"}:`,`${L.artist} - ${L.name}`),L}catch(n){throw this.logError("Failed to fetch latest listen:",n),n}}},{key:"getErrorMessage",value:function(n){return n.error?n.error:n.message?n.message:n.toString()||"Unknown error"}}]),t})(ie);const T=(function(){function e(){V(this,e),this.serviceInstances=new Map}return F(e,[{key:"getService",value:function(t){this.serviceInstances||(this.serviceInstances=new Map);const n=t||o.service;if(!n)throw new Error("[ServiceFactory] No service type specified and no default service configured");return this.serviceInstances.has(n)||this.serviceInstances.set(n,this.createService(n)),this.serviceInstances.get(n)}},{key:"getCurrentService",value:function(){return this.getService(o.service)}},{key:"createService",value:function(t){switch(t){case"lastfm":return new We;case"librefm":return new Je;case"listenbrainz":return new Qe;default:throw new Error(`[ServiceFactory] Unknown service type: ${t}`)}}},{key:"clearCache",value:function(){this.serviceInstances?this.serviceInstances.clear():this.serviceInstances=new Map}},{key:"validateCurrentService",value:function(){return this.getCurrentService().validateCredentials()}},{key:"testService",value:async function(t){try{return await this.getService(t).validateCredentials()}catch(n){return console.error(`[ServiceFactory] Failed to test ${t}:`,n),!1}}},{key:"getSupportedServices",value:function(){return["lastfm","librefm","listenbrainz"]}},{key:"getServiceDisplayName",value:function(t){return this.getService(t).getServiceName()}}],[{key:"getInstance",value:function(){return e.instance||(e.instance=new e),e.instance}}]),e})().getInstance();function Se(e){if(!e||e<0)return"0:00";const t=Math.floor(e/3600),n=Math.floor(e%3600/60),i=Math.floor(e%60);return t>0?`${t}:${n.toString().padStart(2,"0")}:${i.toString().padStart(2,"0")}`:`${n}:${i.toString().padStart(2,"0")}`}function Ee(){return Math.floor(Date.now()/1e3)}var Ze=(function(e){return e[e.PLAYING=0]="PLAYING",e[e.STREAMING=1]="STREAMING",e[e.LISTENING=2]="LISTENING",e[e.COMPETING=5]="COMPETING",e})(Ze||{});const A=function(...e){return console.log("[Scrobble Plugin]",...e)},B=function(...e){return console.error("[Scrobble Plugin] Error:",...e)},I=function(...e){return o.verboseLogging&&console.log("[Scrobble Plugin] Verbose:",...e)},ae=(function(){function e(){V(this,e)}return F(e,[{key:"updateActivity",value:async function(){if(h.pluginStopped){I("Plugin is stopped, skipping update"),this.stopUpdates();return}const t=T.getCurrentService().getServiceName();I(`Fetching latest track from ${t}...`);let n=!1;try{if(o.ignoreSpotify){if(q.findActivity(function(c){return c.sync_id})){I("Spotify is currently playing, clearing activity"),P("isSpotifyIgnored",!0),O();return}P("isSpotifyIgnored",!1)}if(o.ignoreYouTubeMusic){if(q.findActivity(function(c){return c.name==="YouTube Music"||c.application_id==="463097721130188830"||c.name&&c.name.toLowerCase().includes("youtube music")})){I("YouTube Music is currently playing, clearing activity"),P("isYouTubeMusicIgnored",!0),O();return}P("isYouTubeMusicIgnored",!1)}if(o.ignoreKizzy){if(q.findActivity(function(c){return c.name&&c.name.toLowerCase()==="kizzy"})){I("Kizzy is currently playing, clearing activity"),P("isKizzyIgnored",!0),O();return}P("isKizzyIgnored",!1)}if(o.ignoreMetrolist){if(q.findActivity(function(c){return c.name&&c.name.toLowerCase()==="metrolist"})){I("Metrolist is currently playing, clearing activity"),P("isMetrolistIgnored",!0),O();return}P("isMetrolistIgnored",!1)}he();const i=await T.getCurrentService().fetchLatestScrobble();if(P("lastTrack",i),!i.nowPlaying){I("Track is not currently playing"),O();return}if(h.lastTrackUrl===i.url){I("Track hasn't changed"),ve(),this.consecutiveFailures=0;return}n=!0,A(`\u{1F3B5} Track changed: ${i.artist} - ${i.name}`);let a;if(i.nowPlaying&&o.showTimestamp&&i.from){const c=Ee();let g=i.from;if(g<c-3600){if(i.duration&&i.duration>0){const d=Math.min(i.duration*.1,30);g=c-d}else g=c;I("had to estimate start time")}a={start:g*1e3},i.to&&(a.end=i.to*1e3)}I(`\u{1F3AF} Preparing RPC update for: ${i.artist} - ${i.name}`);const s={name:o.appName||l.DEFAULT_APP_NAME,flags:0,type:o.listeningTo?2:0,details:i.name,state:`by ${i.artist}`,status_display_type:1,application_id:l.APPLICATION_ID};if(s.name.includes("{{")){const c={artist:i.artist,name:i.name,album:i.album,service:t};for(const[g,d]of Object.entries(c))s.name=s.name.replace(new RegExp(`{{${g}}}`,"g"),d||"")}if(a&&(s.timestamps=a,I("Timestamps set:",{start:new Date(a.start).toISOString(),end:a.end?new Date(a.end).toISOString():"none",duration:i.duration?Se(i.duration):"unknown"})),i.album||i.albumArt){const c=i.albumArt?[i.albumArt]:[],g=await qe(c);if(g[0]){const d=i.album?`on ${i.album}`:`${i.artist} - ${i.name}`,v=o.showTimestamp&&i.duration?` \u2022 ${Se(i.duration)}`:"";s.assets={large_image:g[0],large_text:d+v},I("Album art set:",g[0])}else i.album&&(s.assets={large_text:`on ${i.album}`})}I("Setting Discord activity:",s),P("lastActivity",s),await be(s),h.lastTrackUrl=i.url,this.currentActivity=s,h.lastActivity=s,this.consecutiveFailures=0,this.lastUpdateTime=Ee(),ve(),A(`\u2705 RPC updated successfully: ${i.artist} - ${i.name}`)}catch(i){B("Update failed:",i),X(o.service,i.message),this.handleError(i)}}},{key:"handleError",value:function(t){this.consecutiveFailures++,P("lastError",t),B(`Failure ${this.consecutiveFailures}/${l.MAX_RETRY_ATTEMPTS}:`,t.message),this.consecutiveFailures>=l.MAX_RETRY_ATTEMPTS&&(B("Max retry attempts reached, initiating reconnection..."),this.startReconnection())}},{key:"startReconnection",value:function(){var t=this;this.isReconnecting||(this.isReconnecting=!0,this.stopUpdates(),A("Starting reconnection process..."),this.reconnectTimer=setInterval(function(){A("Attempting to reconnect..."),t.initialize().then(function(){A("Reconnection successful!"),t.stopReconnection()}).catch(function(n){B("Reconnection attempt failed:",n.message)})},l.RETRY_DELAY))}},{key:"stopReconnection",value:function(){try{this.reconnectTimer&&(clearInterval(this.reconnectTimer),this.reconnectTimer=void 0),this.isReconnecting=!1,this.consecutiveFailures=0}catch(t){console.error("[Scrobble Plugin] Reconnection cleanup error:",t)}}},{key:"stopUpdates",value:function(){try{this.updateTimer&&(clearInterval(this.updateTimer),this.updateTimer=void 0)}catch(t){console.error("[Scrobble Plugin] Timer cleanup error:",t)}}},{key:"initialize",value:async function(){var t=this;if(h.pluginStopped)throw new Error("Plugin is stopped");const n=T.getCurrentService().getServiceName();A(`Initializing with ${n}...`);try{if(!await T.validateCurrentService())throw new Error(`Invalid credentials for ${n}`);A(`${n} credentials validated successfully`)}catch(a){throw B(`Failed to validate ${n} credentials:`,a),a}this.stopUpdates(),A("\u{1F3B5} checking for already playing songs..."),await this.updateActivity();const i=Math.max((Number(o.timeInterval)||l.DEFAULT_SETTINGS.timeInterval)*1e3,l.MIN_UPDATE_INTERVAL*1e3);this.updateTimer=setInterval(function(){return t.updateActivity()},i),A(`Update timer started with interval: ${i}ms (${i/1e3}s)`)}},{key:"stop",value:function(){if(!h.pluginStopped){A("Stopping plugin..."),h.pluginStopped=!0;try{this.stopUpdates(),this.stopReconnection(),O(),A("Plugin stopped successfully")}catch(t){console.error("[Scrobble Plugin] Stop error:",t)}}}},{key:"switchService",value:async function(t){if(h.pluginStopped)return;A(`Switching to ${t}...`);const n=!h.pluginStopped;this.stop();try{T.clearCache(),h.lastTrackUrl=void 0,this.currentActivity=void 0,this.lastUpdateTime=0,n&&(h.pluginStopped=!1,await this.initialize())}catch(i){B("Failed to switch service:",i)}}},{key:"getStatus",value:function(){const t=T.getCurrentService().getServiceName();return{running:!h.pluginStopped,service:t,consecutiveFailures:this.consecutiveFailures,isReconnecting:this.isReconnecting,lastTrackUrl:h.lastTrackUrl,updateInterval:this.updateTimer?"Active":"Inactive"}}}],[{key:"getInstance",value:function(){return e.instance||(e.instance=new e),e.instance}}]),e})().getInstance(),et=function(){return ae.initialize()},se=function(){return ae.stop()},tt=function(e){return ae.switchService(e)};var we,Re,Te,Ie,Ae,ke,Le,Ce,Pe,Ne,$e,Ue,_e,De;const{ScrollView:K}=_.findByProps("ScrollView"),{TableRowGroup:w,TableSwitchRow:$,Stack:N,TableRow:u}=_.findByProps("TableSwitchRow","TableRowGroup","Stack","TableRow"),{TextInput:D}=_.findByProps("TextInput");(we=f.plugin.storage).username??(we.username=""),(Re=f.plugin.storage).apiKey??(Re.apiKey=""),(Te=f.plugin.storage).appName??(Te.appName="Music"),(Ie=f.plugin.storage).timeInterval??(Ie.timeInterval=5),(Ae=f.plugin.storage).showTimestamp??(Ae.showTimestamp=!0),(ke=f.plugin.storage).listeningTo??(ke.listeningTo=!0),(Le=f.plugin.storage).ignoreSpotify??(Le.ignoreSpotify=!0),(Ce=f.plugin.storage).verboseLogging??(Ce.verboseLogging=!1),(Pe=f.plugin.storage).service??(Pe.service="lastfm"),(Ne=f.plugin.storage).librefmUsername??(Ne.librefmUsername=""),($e=f.plugin.storage).librefmApiKey??($e.librefmApiKey=""),(Ue=f.plugin.storage).listenbrainzUsername??(Ue.listenbrainzUsername=""),(_e=f.plugin.storage).listenbrainzToken??(_e.listenbrainzToken=""),(De=f.plugin.storage).addToSidebar??(De.addToSidebar=!0);const p=function(e,t){return f.plugin.storage[e]??t},m=function(e,t){return f.plugin.storage[e]=t};function nt(){M.useProxy(f.plugin.storage);const[,e]=r.React.useReducer(function(n){return n+1},0),t=async function(){E.showToast("Testing Last.fm connection...",S.getAssetIDByName("ClockIcon"));try{await T.testService("lastfm")?E.showToast("\u2705 Last.fm connection successful!",S.getAssetIDByName("CheckIcon")):E.showToast("\u274C Last.fm connection failed",S.getAssetIDByName("XIcon"))}catch{E.showToast("\u274C Connection error",S.getAssetIDByName("XIcon"))}};return r.React.createElement(K,{style:{flex:1},contentContainerStyle:{padding:10}},r.React.createElement(N,{spacing:8},r.React.createElement(w,{title:"Credentials"},r.React.createElement(N,{spacing:4},r.React.createElement(D,{placeholder:"Last.fm Username",value:p("username"),onChange:function(n){m("username",n),e()},isClearable:!0}),r.React.createElement(D,{placeholder:"Last.fm API Key",value:p("apiKey"),onChange:function(n){m("apiKey",n),e()},secureTextEntry:!0,isClearable:!0}))),r.React.createElement(w,{title:"Actions"},r.React.createElement(u,{label:"Test Connection",subLabel:"Verify your Last.fm credentials",trailing:r.React.createElement(u.Arrow,null),onPress:t}),r.React.createElement(u,{label:"Get API Key",subLabel:"Create a Last.fm API key at last.fm/api/account/create",trailing:r.React.createElement(u.Arrow,null),onPress:async function(){try{await Q.Linking.openURL("https://www.last.fm/api/account/create")}catch(n){console.error("Failed to open Last.fm API URL:",n),E.showToast("Failed to open web browser. Please visit: https://www.last.fm/api/account/create",S.getAssetIDByName("XIcon"))}}}))),r.React.createElement(r.ReactNative.View,{style:{height:64}}))}function rt(){M.useProxy(f.plugin.storage);const[,e]=r.React.useReducer(function(n){return n+1},0),t=async function(){E.showToast("Testing Libre.fm connection...",S.getAssetIDByName("ClockIcon"));try{await T.testService("librefm")?E.showToast("\u2705 Libre.fm connection successful!",S.getAssetIDByName("CheckIcon")):E.showToast("\u274C Libre.fm connection failed",S.getAssetIDByName("XIcon"))}catch{E.showToast("\u274C Connection error",S.getAssetIDByName("XIcon"))}};return r.React.createElement(K,{style:{flex:1},contentContainerStyle:{padding:10}},r.React.createElement(N,{spacing:8},r.React.createElement(w,{title:"Credentials"},r.React.createElement(N,{spacing:4},r.React.createElement(D,{placeholder:"Libre.fm Username",value:p("librefmUsername"),onChange:function(n){m("librefmUsername",n),e()},isClearable:!0}),r.React.createElement(D,{placeholder:"Libre.fm API Key",value:p("librefmApiKey"),onChange:function(n){m("librefmApiKey",n),e()},secureTextEntry:!0,isClearable:!0}))),r.React.createElement(w,{title:"Actions"},r.React.createElement(u,{label:"Test Connection",subLabel:"Verify your Libre.fm credentials",trailing:r.React.createElement(u.Arrow,null),onPress:t}),r.React.createElement(u,{label:"Get API Key",subLabel:"Create a Last.fm API key (compatible with Libre.fm)",trailing:r.React.createElement(u.Arrow,null),onPress:async function(){try{await Q.Linking.openURL("https://www.last.fm/api/account/create")}catch(n){console.error("Failed to open Last.fm API URL:",n),E.showToast("Failed to open web browser. Please visit: https://www.last.fm/api/account/create",S.getAssetIDByName("XIcon"))}}}))),r.React.createElement(r.ReactNative.View,{style:{height:64}}))}function it(){M.useProxy(f.plugin.storage);const[,e]=r.React.useReducer(function(n){return n+1},0),t=async function(){E.showToast("Testing ListenBrainz connection...",S.getAssetIDByName("ClockIcon"));try{await T.testService("listenbrainz")?E.showToast("\u2705 ListenBrainz connection successful!",S.getAssetIDByName("CheckIcon")):E.showToast("\u274C ListenBrainz connection failed",S.getAssetIDByName("XIcon"))}catch{E.showToast("\u274C Connection error",S.getAssetIDByName("XIcon"))}};return r.React.createElement(K,{style:{flex:1},contentContainerStyle:{padding:10}},r.React.createElement(N,{spacing:8},r.React.createElement(w,{title:"Credentials"},r.React.createElement(N,{spacing:4},r.React.createElement(D,{placeholder:"ListenBrainz Username",value:p("listenbrainzUsername"),onChange:function(n){m("listenbrainzUsername",n),e()},isClearable:!0}),r.React.createElement(D,{placeholder:"ListenBrainz Token (for private profiles)",value:p("listenbrainzToken"),onChange:function(n){m("listenbrainzToken",n),e()},secureTextEntry:!0,isClearable:!0}))),r.React.createElement(w,{title:"Actions"},r.React.createElement(u,{label:"Test Connection",subLabel:"Verify your ListenBrainz credentials",trailing:r.React.createElement(u.Arrow,null),onPress:t}),r.React.createElement(u,{label:"Get User Token",subLabel:"Get your ListenBrainz user token at listenbrainz.org/settings/",trailing:r.React.createElement(u.Arrow,null),onPress:async function(){try{await Q.Linking.openURL("https://listenbrainz.org/settings/")}catch(n){console.error("Failed to open ListenBrainz settings URL:",n),E.showToast("Failed to open web browser. Please visit: https://listenbrainz.org/settings/",S.getAssetIDByName("XIcon"))}}}))),r.React.createElement(r.ReactNative.View,{style:{height:64}}))}function at(){M.useProxy(f.plugin.storage);const[,e]=r.React.useReducer(function(t){return t+1},0);return r.React.createElement(K,{style:{flex:1},contentContainerStyle:{padding:10}},r.React.createElement(N,{spacing:8},r.React.createElement(w,{title:"Activity Display"},r.React.createElement(N,{spacing:4},r.React.createElement(D,{placeholder:`App Name (Default: ${l.DEFAULT_SETTINGS.appName})`,value:p("appName",l.DEFAULT_SETTINGS.appName),onChange:function(t){m("appName",t),e()},isClearable:!0}),r.React.createElement(D,{placeholder:`Update Interval (Default: ${l.DEFAULT_SETTINGS.timeInterval}s)`,value:String(p("timeInterval",l.DEFAULT_SETTINGS.timeInterval)),onChange:function(t){const n=Number(t);n>=l.MIN_UPDATE_INTERVAL&&(m("timeInterval",n),e())},keyboardType:"numeric",isClearable:!0}))),r.React.createElement(w,{title:"Activity Options"},r.React.createElement($,{label:"Show as Listening",subLabel:"Display as 'Listening to' instead of 'Playing'",value:p("listeningTo",l.DEFAULT_SETTINGS.listeningTo),onValueChange:function(t){m("listeningTo",t),e()}}),r.React.createElement($,{label:"Show Timestamp",subLabel:"Display track progress and duration",value:p("showTimestamp",l.DEFAULT_SETTINGS.showTimestamp),onValueChange:function(t){m("showTimestamp",t),e()}}),r.React.createElement($,{label:"Ignore Spotify",subLabel:"Don't show activity when Spotify is playing",value:p("ignoreSpotify",l.DEFAULT_SETTINGS.ignoreSpotify),onValueChange:function(t){m("ignoreSpotify",t),e()}}),r.React.createElement($,{label:"Ignore YouTube Music",subLabel:"Don't show activity when YouTube Music is playing (PC client)",value:p("ignoreYouTubeMusic",l.DEFAULT_SETTINGS.ignoreYouTubeMusic),onValueChange:function(t){m("ignoreYouTubeMusic",t),e()}}),r.React.createElement($,{label:"Ignore Kizzy",subLabel:"Don't show activity when Kizzy is playing",value:p("ignoreKizzy",l.DEFAULT_SETTINGS.ignoreKizzy),onValueChange:function(t){m("ignoreKizzy",t),e()}}),r.React.createElement($,{label:"Ignore Metrolist",subLabel:"Don't show activity when Metrolist is playing",value:p("ignoreMetrolist",l.DEFAULT_SETTINGS.ignoreMetrolist),onValueChange:function(t){m("ignoreMetrolist",t),e()}}))),r.React.createElement(r.ReactNative.View,{style:{height:64}}))}function st(){M.useProxy(f.plugin.storage);const[,e]=r.React.useReducer(function(t){return t+1},0);return r.React.createElement(K,{style:{flex:1},contentContainerStyle:{padding:10}},r.React.createElement(N,{spacing:8},r.React.createElement(w,{title:"Logging Options"},r.React.createElement($,{label:"Verbose Logging",subLabel:"Enable detailed console logging for debugging",value:p("verboseLogging",l.DEFAULT_SETTINGS.verboseLogging),onValueChange:function(t){m("verboseLogging",t),e()}})),r.React.createElement(w,{title:"Debug Information"},r.React.createElement(u,{label:"Console Logging",subLabel:"Logs are written to the browser/app console when verbose is enabled"}),r.React.createElement(u,{label:"Error Tracking",subLabel:"Connection errors and API failures are automatically logged"})),r.React.createElement(w,{title:"Log Information"},r.React.createElement(u,{label:"API Calls",subLabel:"All API requests are logged when verbose is enabled"}),r.React.createElement(u,{label:"Track Updates",subLabel:"Song changes and RPC updates are logged"}),r.React.createElement(u,{label:"Error Details",subLabel:"Connection errors and retries are logged"}))),r.React.createElement(r.ReactNative.View,{style:{height:64}}))}function ze(){M.useProxy(f.plugin.storage);const e=r.NavigationNative.useNavigation(),[,t]=r.React.useReducer(function(a){return a+1},0),n=p("service"),i=function(a){switch(a){case"lastfm":return p("username")&&p("apiKey")?"\u2705 Configured":"\u274C Missing credentials";case"librefm":return p("librefmUsername")&&p("librefmApiKey")?"\u2705 Configured":"\u274C Missing credentials";case"listenbrainz":return p("listenbrainzUsername")?"\u2705 Configured":"\u274C Missing username";default:return"\u2753 Unknown"}};return r.React.createElement(K,{style:{flex:1},contentContainerStyle:{padding:10}},r.React.createElement(N,{spacing:8},r.React.createElement(w,{title:"Active Service"},r.React.createElement(u,{label:"Current Service",subLabel:n?`Using: ${T.getServiceDisplayName(n)}`:"No service selected"}),["lastfm","librefm","listenbrainz"].map(function(a){return r.React.createElement($,{key:a,label:T.getServiceDisplayName(a),subLabel:i(a),value:n===a,onValueChange:function(s){s&&a!==n&&(m("service",a),t())}})})),r.React.createElement(w,{title:"Service Configuration"},r.React.createElement(u,{label:"Last.fm Settings",subLabel:"Configure Last.fm credentials and options",trailing:r.React.createElement(u.Arrow,null),onPress:function(){return e.push("VendettaCustomPage",{title:"Last.fm Settings",render:nt})}}),r.React.createElement(u,{label:"Libre.fm Settings",subLabel:"Configure Libre.fm credentials and options",trailing:r.React.createElement(u.Arrow,null),onPress:function(){return e.push("VendettaCustomPage",{title:"Libre.fm Settings",render:rt})}}),r.React.createElement(u,{label:"ListenBrainz Settings",subLabel:"Configure ListenBrainz credentials and options",trailing:r.React.createElement(u.Arrow,null),onPress:function(){return e.push("VendettaCustomPage",{title:"ListenBrainz Settings",render:it})}})),r.React.createElement(w,{title:"Plugin Configuration"},r.React.createElement(u,{label:"Display Settings",subLabel:"Customize how music activity appears",trailing:r.React.createElement(u.Arrow,null),onPress:function(){return e.push("VendettaCustomPage",{title:"Display Settings",render:at})}}),r.React.createElement(u,{label:"Logging Settings",subLabel:"Configure logging and debugging options",trailing:r.React.createElement(u.Arrow,null),onPress:function(){return e.push("VendettaCustomPage",{title:"Logging Settings",render:st})}}),r.React.createElement($,{label:"Add to Sidebar",subLabel:"Show plugin in Discord settings",value:p("addToSidebar",!1),onValueChange:function(a){m("addToSidebar",a),t()}})),r.React.createElement(w,{title:"About"},r.React.createElement(u,{label:"Multi Scrobbler",subLabel:"Show off your music status from multiple services"}),r.React.createElement(u,{label:"Author",subLabel:"kmmiio99o"}),r.React.createElement(u,{label:"Version",subLabel:"1.2.0"}))),r.React.createElement(r.ReactNative.View,{style:{height:64}}))}const{FormSection:ot,FormRow:oe}=xe.Forms,{TableRowIcon:ct}=_.findByProps("TableRowIcon"),W=window.bunny,Me=W?.metro?.findByPropsLazy("getRootNavigationRef"),ce=W?.metro?.findByPropsLazy("SETTING_RENDERER_CONFIG"),Ve=W?.metro?.findByNameLazy("SettingsOverviewScreen",!1);function lt({tabs:e}){const t=r.NavigationNative.useNavigation();return r.React.createElement(oe,{label:e.title(),leading:r.React.createElement(oe.Icon,{source:e.icon}),trailing:r.React.createElement(r.React.Fragment,{},[e.trailing?e.trailing():null,r.React.createElement(oe.Arrow,{key:"arrow"})]),onPress:function(){const n=e.page;t.navigate("VendettaCustomPage",{title:e.title(),render:function(){return r.React.createElement(n)}})}})}function ut(e,t){try{t.push(Z.after("default",W?.metro?.findByNameLazy("UserSettingsOverviewWrapper",!1),function(n,i){const a=ee.findInReactTree(i.props.children,function(s){return s.type?.name==="UserSettingsOverview"});a&&t.push(Z.after("render",a.type.prototype,function(s,c){const g=ee.findInReactTree(c.props.children,function(d){return d?.children?.[1]?.type===ot})?.children;if(g){const d=g.findIndex(function(v){return["BILLING_SETTINGS","PREMIUM_SETTINGS"].includes(v?.props?.label)});g.splice(-~d||4,0,r.React.createElement(lt,{key:e.key,tabs:e}))}}))},!0))}catch(n){f.logger.info("Panel UI patch failed graciously \u{1F494}",n)}}function gt(e,t){if(!ce||!Ve||!Me){console.warn("[LastFm] Missing required constants for tabs UI patch");return}const n={};n[e.key]={type:"pressable",title:e.title,icon:e.icon,IconComponent:e.icon&&function(){const s=typeof e.icon=="object"&&e.icon.uri!==void 0?e.icon.uri:e.icon;return r.React.createElement(ct,{source:s})},usePredicate:e.predicate,useTrailing:e.trailing,onPress:function(){const s=Me.getRootNavigationRef(),c=e.page;s.navigate("VendettaCustomPage",{title:e.title(),render:function(){return r.React.createElement(c)}})},withArrow:!0};let i=ce.SETTING_RENDERER_CONFIG;Object.defineProperty(ce,"SETTING_RENDERER_CONFIG",{enumerable:!0,configurable:!0,get:function(){return{...i,...n}},set:function(s){return i=s}});const a=Symbol("LastFm-pinToSettings");t.push(Z.after("default",Ve,function(s,c){if(!s[0][a]){s[0][a]=!0;const{sections:g}=ee.findInReactTree(c,function(v){return v.props?.sections}).props,d=g?.find(function(v){return["Bunny","Revenge","Kettu","Vencore"].some(function(k){return v.label===k&&v.title===k})});d?.settings&&(d.settings=[...d.settings,e.key])}}))}function ft(e){const t=[];let n=!1;const i=e.predicate||function(){return!0};return e.predicate=function(){return n?!1:i()},ut(e,t),gt(e,t),t.push(function(){return n=!0}),function(){for(const a of t)a()}}function Fe(){if(!f.plugin.storage.addToSidebar)return console.log("[Multi Scrobbler] Sidebar disabled in settings"),function(){};console.log("[Multi Scrobbler] Patching sidebar using custom patchSettingsPin...");try{const e=ft({key:"LastFmScrobbler",icon:S.getAssetIDByName("MusicIcon"),title:function(){return"Multi Scrobbler"},predicate:function(){return f.plugin.storage.addToSidebar===!0},page:ze});return console.log("[Multi Scrobbler] Successfully patched sidebar"),e}catch(e){return console.error("[Multi Scrobbler] Failed to patch sidebar:",e),function(){}}}var Oe;const h={pluginStopped:!1,lastActivity:void 0,updateInterval:void 0,lastTrackUrl:void 0},le=[];let z;const Be=l.DEFAULT_SETTINGS;for(const e of Object.keys(Be))f.plugin.storage[e]=f.plugin.storage[e]??Be[e];(Oe=f.plugin.storage).addToSidebar??(Oe.addToSidebar=!1);const o=new Proxy(f.plugin.storage,{get(e,t){return e[t]},set(e,t,n){return e[t]=n,!0}});let J=0;const ue=3,dt=5e3,y=function(...e){return console.log("[Scrobble Plugin]",...e)},ge=function(...e){return console.error("[Scrobble Plugin] Error:",...e)};async function Y(){try{await et(),J=0,y("Plugin initialized successfully")}catch(e){ge("Initialization failed:",e),J++,J<ue?(y(`Retrying connection (${J}/${ue})...`),setTimeout(Y,dt)):ge(`Failed to connect after ${ue} attempts`)}}async function pt(){if(!o.service){y("No service selected. Please configure a service in plugin settings.");return}const e=T.getCurrentService().getServiceName(),t=o.service;let n=!1;switch(t){case"lastfm":n=!!(o.username&&o.apiKey);break;case"librefm":n=!!(o.librefmUsername&&o.librefmApiKey);break;case"listenbrainz":n=!!o.listenbrainzUsername;break}if(!n){ge(`Missing credentials for ${e}. Please configure in plugin settings.`);return}if(y(`Starting with ${e}...`),de.getCurrentUser())y("Discord is already connected, initializing immediately..."),await Y();else{y("Waiting for Discord connection...");const i=function(){de.getCurrentUser()&&(y("Discord connection established"),Y(),r.FluxDispatcher.unsubscribe("CONNECTION_OPEN",i))};r.FluxDispatcher.subscribe("CONNECTION_OPEN",i)}}var bt={onLoad(){if(y("Plugin loading..."),h.pluginStopped=!1,!o.service)y("No service configured. Please select a service in plugin settings.");else{const e=T.getCurrentService().getServiceName();y(`Configuration: Service=${e}, Update Interval=${o.timeInterval}s, Verbose=${o.verboseLogging}`)}try{z=Fe(),le.push(function(){z&&(z(),z=void 0)})}catch(e){y("Sidebar setup failed:",e)}pt()},onUnload(){y("Plugin unloading..."),h.pluginStopped=!0,le.forEach(function(e){try{e()}catch{}}),le.length=0,se(),y("Plugin unloaded")},async onSettingsUpdate(e){const t=o.service,n=e.service,i=o.addToSidebar,a=e.addToSidebar;if(Object.assign(o,e),y("Settings updated:",Object.keys(e)),i!==a)if(a)try{z=Fe(),y("Sidebar enabled")}catch(s){y("Failed to enable sidebar:",s)}else z&&(z(),z=void 0,y("Sidebar disabled"));t!==n&&n?(y(`Service changed from ${t||"none"} to ${n}`),await tt(n)):!h.pluginStopped&&o.service?(y("Restarting with updated settings..."),await Y()):o.service||(y("Service unselected, stopping plugin..."),se())},onDiscordReconnect(){h.pluginStopped||(y("Discord reconnected, reinitializing plugin..."),Y())},settings:ze};return x.currentSettings=o,x.default=bt,x.pluginState=h,Object.defineProperty(x,"__esModule",{value:!0}),x})({},vendetta,vendetta.metro.common,vendetta.metro,window.React,vendetta.storage,vendetta.metro.common.ReactNative,vendetta.ui.toasts,vendetta.ui.assets,vendetta.patcher,vendetta.ui.components,vendetta.utils);
